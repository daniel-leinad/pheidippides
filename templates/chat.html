<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Hello!</title>
</head>
<script>
  var messagesBuffer = [];
  var noMoreOldMessages = false;

  var current_chat_id = null;
  function updateCurrentChat() {
    if (current_chat_id) {
      let previousChat = document.getElementById("chat_" + current_chat_id);
      // might not exist because of search
      if (previousChat) {
        previousChat.setAttribute("class", "chat");
      };
    };
    current_chat_id = location.pathname.replace("/chat/", "").replace("/chat", "");
    if (current_chat_id) {
      // must exist
      document.getElementById("chat_" + current_chat_id).setAttribute("class", "currentChat");
      loadMessages();
      document.getElementById("replyForm").toggleAttribute("hidden", false);
    } else {
      document.getElementById("messages").innerHTML = "";
      document.getElementById("replyForm").toggleAttribute("hidden", true);
    };
    document.getElementById("message_box").value = "";
  }

  function chatWith(id) {
    if (id != current_chat_id) {
      history.pushState({}, "", "\\chat\\" + id);
    };
    updateCurrentChat();
  }

  /*
  Load messages for a new chat (e.g after changing current chat)
  clears messagesBuffer
  */
  async function loadMessages() {
    let response = await fetch("/json/messages/" + current_chat_id, {
      method: "GET"
    });
    let response_body = await response.json();
    if (response_body.success) {
      messagesBuffer = response_body.messages;
    } else {
      handleFetchMessagesError(response_body.error);
      return;
    };
    noMoreOldMessages = false;

    redrawMessages(false);

    let messages = document.getElementById("messages");
  }

  /*
  Load old messages for the current chat
  extends messagesBuffer
  */
  async function loadMoreOldMessages() {
    if (noMoreOldMessages) {
      return;
    };

    let url = "";

    if (messagesBuffer.length == 0) {
      url = "/json/messages/" + current_chat_id;
    } else {
      let firstMessageId = messagesBuffer[0].id;
      url = "/json/messages/" + current_chat_id + "?from=" + firstMessageId
    }

    let response = await fetch(url, {method: "GET"});

    response_body = await response.json();

    if (!response_body.success) {
      handleFetchMessagesError(response_body.error);
      return;
    };

    let fetchedMessages = response_body.messages;

    if (fetchedMessages.length) {
      messagesBuffer = [...fetchedMessages, ...messagesBuffer];
    } else {
      noMoreOldMessages = true;
    }

    redrawMessages(true);
  }

  function redrawMessages(saveScrollPosition) {
    let messages = document.getElementById("messages");
    let scrollFromBottom = 0;
    if (saveScrollPosition) {
      scrollFromBottom = messages.scrollHeight - messages.scrollTop;
    };
    messages.replaceChildren();

    if (noMoreOldMessages) {
      let el = document.createElement("div");
      el.setAttribute("id", "noMoreOldMessages");
      el.appendChild(document.createTextNode("Больше нет"));
      messages.appendChild(el);
    } else {
      let el = document.createElement("div");
      el.setAttribute("id", "loadMoreOldMessages");
      el.appendChild(document.createTextNode("Загрузить еще"));
      el.addEventListener("click", loadMoreOldMessages);
      messages.appendChild(el);
    };

    for (msg of messagesBuffer) {
      let el = document.createElement("div");
      switch (msg.type) {
        case "In":
          el.setAttribute("class", "messageIn");
          break;
        case "Out":
          el.setAttribute("class", "messageOut");
          break;
        default:
          console.error("Unexpected message type: " + msg.type);
      }
      let messageText = document.createTextNode(msg.message);
      el.appendChild(messageText);

      messages.appendChild(el);
    }

    messages.scrollTo(0, messages.scrollHeight - scrollFromBottom);
  }

  function handleFetchMessagesError(error) {
    switch (error) {
        case "Unauthorized":
          location.href = "/login";
          break;
        default:
          console.error("Unexpected error from /json/messages");
      };
  }

  addEventListener("load", function (e) {
    updateCurrentChat();

    document.getElementById("send_button").addEventListener("click", async function () {
      if (!document.getElementById("replyForm").reportValidity()) {
        return;
      }

      await fetch("/message/" + current_chat_id, {
        method: "POST",
        body: JSON.stringify({
          message: document.getElementById("message_box").value
        })
      });

      document.getElementById("message_box").value = "";

      loadMessages();
    });

    document.getElementById("chatSearchButton").addEventListener("click", async function () {
      let query = document.getElementById("chatSearchBox").value;
      let chats = document.getElementById("chats");

      if (query) {
        let queryParams = new FormData();
        queryParams.set("query", query);
        let response = await fetch("/html/chatsearch?" + new URLSearchParams(queryParams).toString(), { method: "GET" });
        chats.innerHTML = await response.text();
      } else {
        let response = await fetch("/html/chats", { method: "GET" });
        chats.innerHTML = await response.text();
      }
    });

    document.getElementById("messages").addEventListener("scrollend", function (e) {
      if (document.getElementById("messages").scrollTop === 0) {
        loadMoreOldMessages();
      }
    })
  });

  addEventListener("popstate", function (e) {
    updateCurrentChat();
  })
</script>
<style>
  body {
    font: normal;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: large;
  }

  button {
    font-size: large;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  input {
    font-size: large;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  div.scroll {
    overflow-y: scroll;
  }

  div.chat_container {
    display: grid;
    grid-template-columns: 20% auto 1rem;
    grid-template-rows: 2rem 90%;
    position: fixed;
    height: 100%;
    width: 100%;
  }

  div.greeting {
    grid-column: 1 / 3;
    grid-row: 1;
  }

  div.leftColumn {
    grid-row: 2;
    grid-column: 1;
    width: 100%;
    height: 100%;
  }

  div.chat {
    user-select: none;
    cursor: pointer;
  }

  div.currentChat {
    border: solid;
    border-color: gray;
    user-select: none;
    cursor: pointer;
  }

  div.rightColumn {
    grid-row: 2;
    grid-column: 2;
    width: 100%;
    height: 100%;
  }

  div.rightColumn div {
    display: block;
    width: 100%;
  }

  div.chats {
    height: 100%;
  }

  div.messages {
    display: grid;
    height: 100%;
  }

  div.replyBox {
    text-align: right;
  }

  div.replyBox input {
    display: inline;
  }

  div.messageIn {
    text-align: left;
  }

  div.messageOut {
    text-align: right;
  }

  #loadMoreOldMessages {
    text-align: center;
    cursor: pointer;
    color: grey;
  }

  #noMoreOldMessages {
    text-align: center;
    user-select: none;
  }

  div.messages div:hover {
    background-color: beige;
  }

  div.chats div:hover {
    background-color: beige;
  }
</style>

<body>
  <div class="chat_container">
    <div class="greeting">Привет, {{ username }} <a href="/logout">выйти</a></div>
    <div class="leftColumn">
      <div class="chatSearch">
        <form name="chatSearchForm" action="javascript:void(0);">
          <input type="text" name="chatSearchBox" id="chatSearchBox" style="width: 50%;" />
          <button name="chatSearchButton" id="chatSearchButton">Поиск</button>
        </form>
      </div>
      <div class="chats scroll" id="chats">
        {% include "elements/chats.html" %}
      </div>
    </div>
    <div class="rightColumn">
      <div class="messages scroll" id="messages">
      </div>
      <div class="replyBox" id="replyBox">
        <form id="replyForm" action="javascript:void(0);" hidden>
          <input type="text" name="message" style="width: 75%;" id="message_box" required />
          <button id="send_button">Отправить</button>
        </form>
      </div>
    </div>
  </div>
</body>

</html>